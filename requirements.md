# プログラム仕様書

## 1. プログラム概要
- Python 3.11.2で動作する自動YouTube配信プログラム。
- プログラム起動と同時に指定されたYouTubeライブストリームIDへRTMP配信を開始し、プロセスが停止されるまで継続する。
- 映像として`display/image.(jpg|png)`を静止画で表示し、必要に応じて低ビットレートのループ動画を生成する。音声は`audio/`内のMP3をランダム再生して合成配信する。

## 2. 機能仕様
### 2.1 配信開始・終了制御
- 環境変数でYouTubeライブの`stream_url`と`stream_key`を指定する。
- プログラム起動時にFFmpegプロセスを立ち上げ、RTMP送信を開始する。
- プロセスが終了するまでFFmpeg出力を継続し、ユーザーは任意の方法でプロセスを停止する。

### 2.2 音声再生
- `audio/` フォルダ内のMP3ファイルをスキャンし、プレイリストを生成する。
- 再生順はランダムシャッフル。すべて再生後は再度シャッフルして繰り返す。
- エラー発生時は次のトラックへスキップし、発生状況をログに記録する。

- `display/` フォルダ内の静止画`image.jpg`を監視し、存在する場合は起動時に480p/30fpsの低ビットレート動画へ自動変換してループ再生する。
- 静止画が存在しない場合は黒一色の背景を生成して出力する。
- 映像は出力480pにスケーリングし、ソースのアスペクト比を維持したまま横幅をフレーム幅にフィットさせ、高さ方向は余りが出る場合に上下黒帯で補完する。

### 2.4 配信エンコード・送出
- FFmpegを利用し、動画と音声を統合したRTMPストリームを生成する。
- 出力は480p30fpsとし、静止画は80kbpsでエンコードした120秒ループ動画として送出し、音声は64kbps AACとする。
- RTMP(S)でYouTube Live配信用のエンドポイントへ送信する。
- 接続断を検知した場合、一定間隔で自動再接続を試みる。

### 2.5 モニタリングと通知
- ビットレート、ドロップフレーム、CPU/メモリ使用率を一定間隔で取得し、標準出力に表示する。
- 配信開始・終了・エラー発生時はコンソールへメッセージを出力する。
- 任意でDiscord Webhook URLを設定した場合、1日ごとに動作状況をポストし、エラー発生時には即座に通知する。

### 2.6 設定管理
- 配信に必要な情報は`.env`ファイルで管理し、プログラム起動時に読み込む。
- `.env` ファイルでは以下を定義する:
  - `YOUTUBE_STREAM_URL`: YouTubeのRTMPエンドポイントURL
  - `YOUTUBE_STREAM_KEY`: 送信に使用するストリームキー
- 任意で`DISCORD_WEBHOOK_URL`を設定すると、モニタリング結果をDiscordへ通知できる。
- その他のパラメータはソースコード内の定数またはCLI引数で設定し、必要に応じて再起動で反映する。

### 2.7 操作インターフェース
- CLI: `python main.py` を実行すると即座に配信を開始し、停止はプロセス終了で行う。

## 3. 外部連携
- RTMP(S)でYouTube Live配信用のエンドポイントへ送信する。

## 4. 非機能要件
- 動作環境: Python 3.11.2を使用し、依存パッケージのバージョンも固定する。
- 信頼性: 回線断・FFmpeg異常を検知し、1分以内に再送を試みる。
- 性能: 480p30fpsで安定配信、エンドツーエンド遅延は低遅延モードで3秒以内。
- 保守性: コードはPEP 8準拠、ユニットテストカバレッジ60%以上を目標。
- 監視性: ログは構造化JSONで保存し、保持期間は30日。
- セキュリティ: 認証情報は暗号化保存、監視ダッシュボード提供時は認証を必須とし、HTTPS/TLSの利用を推奨。

## 5. 入出力ディレクトリ
- `audio/`: MP3音源ファイルを配置。ファイル追加・削除はホットリロードで検知する。
- `display/`: 配信映像用メディアを配置。静止画`image.jpg`を置くと自動でループ用動画が生成され、未配置時は黒背景を配信する。
